<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao di·ªán b√†i thi tr·∫Øc nghi·ªám</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            padding: 20px;
        }
        .header-fixed {
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #f9fafb;
            padding: 12px 24px;
            border-bottom: 1px solid #e5e7eb;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }
        .footer-fixed {
            position: sticky;
            bottom: 0;
            z-index: 20;
            background-color: #f9fafb;
            padding: 12px 24px;
            border-top: 1px solid #e5e7eb;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #f9fafb;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 0;
        }
        .button {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .answer-label {
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        input[type="radio"]:checked + .answer-label,
        input[type="checkbox"]:checked + .answer-label {
            background-color: #e5e7eb;
            border-color: #d1d5db;
        }
        .quiz-option {
            transition: all 0.2s ease;
            font-size: 0.875rem; /* text-sm */
            position: relative;
            overflow: hidden;
        }
        .quiz-option:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
        }
        .quiz-option.answered {
            background-color: #d1d5db; /* M√†u x√°m m·ªù */
            color: #1f2937; /* M√†u ch·ªØ x√°m ƒë·∫≠m */
        }
        .quiz-option.unanswered {
            background-color: #ffffff; /* M√†u tr·∫Øng */
            color: #4b5563; /* M√†u ch·ªØ x√°m */
            border: 1px solid #d1d5db;
        }
        /* Style for Flagged but not Answered */
        .quiz-option.flagged.unanswered {
            background: linear-gradient(to top right, #fde68a 50%, #ffffff 50%);
            border: 1px solid #d1d5db;
        }
        /* Style for Answered and Flagged */
        .quiz-option.answered.flagged {
            background: linear-gradient(to top right, #fde68a 50%, #d1d5db 50%);
            color: #1f2937;
        }

        #overlay, #confirm-overlay, #submit-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        #timer.red-text {
            color: #ef4444; /* M√†u ƒë·ªè c·ªßa Tailwind */
        }
        #timer.blue-text {
            color: #3b82f6; /* M√†u xanh c·ªßa Tailwind */
        }

        /* Gi·∫£m kho·∫£ng c√°ch t·ªëi ƒëa gi·ªØa c√°c c√¢u h·ªèi */
        #quiz-content {
            padding: 0.5rem 1.5rem; /* Gi·∫£m padding t·ªïng th·ªÉ */
            line-height: 1.25; /* Th√™m line-height ƒë·ªÉ gi·∫£m kho·∫£ng c√°ch gi·ªØa c√°c d√≤ng */
        }
        .question-item {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem; /* Gi·∫£m padding cho t·ª´ng c√¢u h·ªèi */
        }
        /* Gi·∫£m kho·∫£ng c√°ch gi·ªØa c√¢u h·ªèi v√† ƒë√°p √°n */
        .question-body {
            margin-bottom: 0.5rem; /* Gi·∫£m kho·∫£ng c√°ch */
        }
        /* Gi·∫£m kho·∫£ng c√°ch gi·ªØa c√°c ƒë√°p √°n */
        .answers-container {
            margin-top: 0.25rem;
        }
        .answer-option {
            margin-bottom: 0.25rem; /* Gi·∫£m kho·∫£ng c√°ch gi·ªØa c√°c ƒë√°p √°n */
        }
        /* G·∫°ch ngang ph√¢n c√°ch */
        .question-item + .question-item {
            border-top: 1px solid #d1d5db; /* M√†u x√°m m·ªù */
            margin-top: 0.5rem;
            padding-top: 0.5rem;
        }
        /* CSS cho thi·∫øt b·ªã di ƒë·ªông */
        @media (max-width: 639px) {
            .mobile-hidden {
                display: none !important;
            }
            #dropdown-button, #questions-per-page-display {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center">

    <!-- Subject Selection Interface -->
    <div id="subject-selection" class="container relative p-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">Ca thi c·ªßa t√¥i</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Subject 1 -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-between">
                <h3 class="text-xl font-semibold text-gray-700 text-center mb-2">M√¥n 1: Ph√°p lu·∫≠t h·∫£i quan</h3>
                <p class="text-gray-500 mb-4 text-center">80 c√¢u tr·∫Øc nghi·ªám / 50 ph√∫t</p>
                <button class="start-btn button bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400" data-subject="Ph√°p lu·∫≠t h·∫£i quan"
data-subject-id="1">B·∫Øt ƒë·∫ßu</button>
            </div>
            <!-- Subject 2 -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-between">
                <h3 class="text-xl font-semibold text-gray-700 text-center mb-2">M√¥n 2: K·ªπ thu·∫≠t nghi·ªáp v·ª• ngo·∫°i th∆∞∆°ng</h3>
                <p class="text-gray-500 mb-4 text-center">80 c√¢u tr·∫Øc nghi·ªám / 50 ph√∫t</p>
                <button class="start-btn button bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400" data-subject="K·ªπ thu·∫≠t nghi·ªáp v·ª• ngo·∫°i th∆∞∆°ng">B·∫Øt ƒë·∫ßu</button>
            </div>
            <!-- Subject 3 -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-between">
                <h3 class="text-xl font-semibold text-gray-700 text-center mb-2">M√¥n 3: K·ªπ thu·∫≠t nghi·ªáp v·ª• h·∫£i quan</h3>
                <p class="text-gray-500 mb-4 text-center">80 c√¢u tr·∫Øc nghi·ªám / 50 ph√∫t</p>
                <button class="start-btn button bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400" data-subject="K·ªπ thu·∫≠t nghi·ªáp v·ª• h·∫£i quan">B·∫Øt ƒë·∫ßu</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Starting Quiz -->
    <div id="confirm-overlay" class="fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 id="confirm-message" class="text-lg font-bold text-gray-800 text-center mb-4"></h3>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes" class="button bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">C√≥</button>
                <button id="confirm-no" class="button bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400">Kh√¥ng</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Submitting Quiz -->
    <div id="submit-overlay" class="fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 class="text-lg font-bold text-gray-800 text-center mb-4">B·∫°n ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?</h3>
            <p id="submit-summary" class="text-gray-600 text-center mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="submit-yes" class="button bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400">C√≥</button>
                <button id="submit-no" class="button bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400">Kh√¥ng</button>
            </div>
        </div>
    </div>

    <!-- Main Quiz Container -->
    <div id="quiz-container" class="container relative hidden">
        <!-- Header -->
        <div class="header-fixed flex flex-col items-center justify-center">
            <!-- Subject Title -->
            <h2 class="text-xl font-semibold text-gray-700 quiz-subject-title"></h2>
            <!-- Page Select and Timer container -->
            <div class="flex items-center space-x-4 mt-2">
                <!-- Page Select Dropdown -->
                <div class="relative inline-block text-left page-select-container sm:inline-block">
                    <button id="dropdown-button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        S·ªë c√¢u/trang: <span id="questions-per-page-display"></span>
                    </button>
                    <div id="dropdown-menu" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="3">3 c√¢u</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="5">5 c√¢u</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="10">10 c√¢u</a>
                        </div>
                    </div>
                </div>
                <!-- Timer -->
                <div class="flex items-center space-x-2">
                    <span class="text-md text-gray-700 whitespace-nowrap mobile-hidden">Th·ªùi gian c√≤n l·∫°i:</span>
                    <span id="timer" class="text-2xl font-bold px-4 py-1 rounded-full">50:00</span>
                </div>
            </div>
        </div>

        <!-- Main Quiz Content -->
        <div id="quiz-content" class="space-y-6 p-6">
            <!-- Questions will be injected here by JavaScript -->
        </div>

        <!-- Bottom Controls -->
        <div class="footer-fixed flex flex-wrap items-center justify-between space-y-4 md:space-y-0">
            <div class="flex space-x-2 button-group-top w-full md:w-auto justify-center md:justify-start">
                <button id="prev-btn" class="button bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">Trang tr∆∞·ªõc</button>
                <button id="next-btn" class="button bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">Trang sau</button>
                <button id="quick-select-btn" class="button bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 whitespace-nowrap">
                    Ch·ªçn c√¢u h·ªèi
                </button>
            </div>
            <div class="flex w-full md:w-auto justify-center md:justify-end">
                <button id="submit-btn" class="button bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400">N·ªôp b√†i</button>
            </div>
        </div>
    </div>

    <!-- Quick Select Modal -->
    <div id="overlay" class="fixed inset-0 hidden flex items-center justify-center z-50">
        <div id="modal" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-2">
                    <h3 class="text-2xl font-bold text-gray-800">Ch·ªçn c√¢u h·ªèi</h3>
                    <!-- Modal Timer with label -->
                    <div class="flex items-center space-x-2">
                        <span class="text-md text-gray-700 whitespace-nowrap">Th·ªùi gian c√≤n l·∫°i:</span>
                        <span id="modal-timer" class="text-2xl font-bold text-blue-500">50:00</span>
                    </div>
                </div>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div id="legend" class="flex justify-center mb-4 text-sm space-x-4">
                <div class="flex items-center">
                    <span class="w-4 h-4 rounded-full bg-gray-200 mr-2"></span> ƒê√£ tr·∫£ l·ªùi
                </div>
                <div class="flex items-center">
                    <span class="w-4 h-4 rounded-full bg-white border border-gray-300 mr-2"></span> Ch∆∞a tr·∫£ l·ªùi
                </div>
                <div class="flex items-center">
                    <span class="w-4 h-4 rounded-full bg-yellow-300 mr-2"></span> Ch∆∞a ch·∫Øc ch·∫Øn
                </div>
            </div>
            <div id="question-grid" class="grid gap-1">
                <!-- Question buttons will be injected here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const quizContainer = document.getElementById('quiz-container');
            const subjectSelection = document.getElementById('subject-selection');
            const quizSubjectTitle = document.querySelector('.quiz-subject-title');
            const startButtons = document.querySelectorAll('.start-btn');
            
            // Confirmation modal elements for starting quiz
            const confirmOverlay = document.getElementById('confirm-overlay');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmYesBtn = document.getElementById('confirm-yes');
            const confirmNoBtn = document.getElementById('confirm-no');

            // Confirmation modal elements for submitting quiz
            const submitOverlay = document.getElementById('submit-overlay');
            const submitSummary = document.getElementById('submit-summary');
            const submitYesBtn = document.getElementById('submit-yes');
            const submitNoBtn = document.getElementById('submit-no');

            const quizContent = document.getElementById('quiz-content');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const quickSelectBtn = document.getElementById('quick-select-btn');
            const submitBtn = document.getElementById('submit-btn');
            const overlay = document.getElementById('overlay');
            const modal = document.getElementById('modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const questionGrid = document.getElementById('question-grid');
            const dropdownButton = document.getElementById('dropdown-button');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const questionsPerPageDisplay = document.getElementById('questions-per-page-display');
            const timerDisplay = document.getElementById('timer');
            const modalTimerDisplay = document.getElementById('modal-timer');

            const totalQuestions = 80;
            let questionsPerPage = 10;
            
            // Set default questions per page based on screen size
            const isMobile = window.innerWidth < 640;
            if (isMobile) {
                questionsPerPage = 3;
            } else {
                questionsPerPage = 10;
            }
            questionsPerPageDisplay.textContent = questionsPerPage;

            let currentPage = 1;
            let quizState = [];
            let timer;
            let timeLeft = 50 * 60; // 50 minutes in seconds
            const warningTime = 5 * 60; // 5 minutes in seconds

            // Map integer index to corresponding letter
            const answerMap = ['A', 'B', 'C', 'D'];

            // Initialize quiz state
            // ‚ö†Ô∏è X√ìA H√ÄM initializeQuiz() hi·ªán t·∫°i
    
            
           // Handle start button clicks with custom confirmation
startButtons.forEach(button => {
    button.addEventListener('click', () => {
        const subjectTitle = button.getAttribute('data-subject');
        const subjectId = button.getAttribute('data-subject-id'); // nh·ªõ th√™m trong HTML

        // Hi·ªán overlay x√°c nh·∫≠n
        confirmMessage.textContent = `B·∫°n ch·∫Øc ch·∫Øn l√†m b√†i thi th·ª≠ m√¥n ${subjectTitle} kh√¥ng?`;
        confirmOverlay.classList.remove('hidden');

        const cleanup = () => {
            confirmYesBtn.removeEventListener('click', handleYes);
            confirmNoBtn.removeEventListener('click', handleNo);
        };

        const handleYes = async () => {
            quizSubjectTitle.textContent = `M√¥n thi: ${subjectTitle}`;
            subjectSelection.classList.add('hidden');
            quizContainer.classList.remove('hidden');

            // üü® G·ªçi API l·∫•y c√¢u h·ªèi
            await fetchQuestions(subjectId);

            confirmOverlay.classList.add('hidden');
            cleanup();
        };

        const handleNo = () => {
            confirmOverlay.classList.add('hidden');
            cleanup();
        };

        confirmYesBtn.addEventListener('click', handleYes);
        confirmNoBtn.addEventListener('click', handleNo);
    });
});

async function fetchQuestions(subjectId) {
    try {
        const res = await fetch('/api/get-exam', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',   // üü® ƒë·ªÉ g·ª≠i cookie phi√™n ƒëƒÉng nh·∫≠p
            body: JSON.stringify({ subject_id: subjectId })
        });
        const data = await res.json();

        if (data.questions && data.questions.length > 0) {
            quizState = data.questions.map((q, idx) => ({
                id: q.id,
                index: idx + 1,
                topic: q.ma_mon_thi,
                text: q.cau_hoi,
                answers: [q.dap_an_a, q.dap_an_b, q.dap_an_c, q.dap_an_d],
                correct: q.dap_an_dung,
                note: q.ghi_chu || "",
                my_id: q.my_id,
                selected: [],
                isFlagged: false,
                isAnswered: false,
                type: (q.dap_an_dung.length > 1 ? 'checkbox' : 'radio')
            }));

            renderQuestions();
            startTimer(); // ‚è∞ b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
        } else {
            alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c c√¢u h·ªèi t·ª´ server.");
        }
    } catch (err) {
        console.error("fetchQuestions error:", err);
        alert("L·ªói k·∫øt n·ªëi server.");
    }
}



            // Render questions for the current page
            function renderQuestions() {
                const startIndex = (currentPage - 1) * questionsPerPage;
                const endIndex = Math.min(startIndex + questionsPerPage, totalQuestions);
                quizContent.innerHTML = '';
                
                // Add a guard clause to prevent rendering if there are no questions
                if (quizState.length === 0) {
                    console.error("Quiz state is empty. Cannot render questions.");
                    return;
                }
                
                for (let i = startIndex; i < endIndex; i++) {
                    // Check if the current index is within the bounds of quizState
                    if (i >= quizState.length) {
                        break; // Stop the loop if we've gone past the end of the array
                    }
                    const question = quizState[i];
                    const questionElement = document.createElement('div');
                    questionElement.className = 'question-item';
                    questionElement.setAttribute('data-question-id', question.id);
                    questionElement.innerHTML = `
                        <div class="flex items-start question-body">
                            <div class="flex items-center h-5 mr-2">
                                <input id="flag-${question.id}" type="checkbox" ${question.isFlagged ? 'checked' : ''} class="focus:ring-yellow-500 h-4 w-4 text-yellow-600 border-gray-300 rounded-lg">
                            </div>
                            <h4 class="text-md font-medium text-gray-900">
                                C√¢u ${question.id}: <b>${question.text}</b>
                            </h4>
                        </div>
                        <div class="space-y-2 pl-8 answers-container">
                            ${question.answers.map((answer, ansIndex) => {
                                const answerLetter = answerMap[ansIndex];
                                const isChecked = question.selected.includes(answerLetter);
                                return `
                                <div class="flex items-center answer-option">
                                    <input id="q${question.id}-ans${ansIndex}" name="q${question.id}-ans" type="checkbox" value="${answerLetter}" ${isChecked ? 'checked' : ''} class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded-lg">
                                    <label for="q${question.id}-ans${ansIndex}" class="ml-3 block text-sm font-medium text-gray-700 answer-label px-3 py-2 rounded-lg w-full">
                                        ${answer}
                                    </label>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    quizContent.appendChild(questionElement);
                }

                // Update button states
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = endIndex === totalQuestions;
                
                prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);

                // Scroll to the top of the content area
                quizContent.scrollTop = 0;
            }

            // Render modal quick select grid
            function renderQuickSelectGrid() {
                questionGrid.innerHTML = '';
                for (let i = 1; i <= totalQuestions; i++) {
                    const question = quizState[i - 1];
                    const button = document.createElement('button');
                    let colorClass = 'unanswered'; // Default
                    if (question.isAnswered) {
                        colorClass = 'answered';
                    }
                    if (question.isFlagged) {
                        colorClass = 'flagged';
                    }
                    // Special case: flagged but not answered
                    if (question.isFlagged && !question.isAnswered) {
                        colorClass = 'flagged unanswered';
                    }
                    // Special case: answered and flagged
                    if (question.isAnswered && question.isFlagged) {
                        colorClass = 'answered flagged';
                    }
                    
                    button.className = `w-10 h-10 rounded-lg shadow-sm flex items-center justify-center font-bold quiz-option ${colorClass}`;
                    button.textContent = i;
                    button.setAttribute('data-question-id', i);
                    questionGrid.appendChild(button);
                }
            }

            // Update quiz state when user interacts
            function updateQuizState() {
                const visibleQuestions = quizContent.querySelectorAll('[data-question-id]');
                visibleQuestions.forEach(qElement => {
                    const id = parseInt(qElement.getAttribute('data-question-id'));
                    const question = quizState[id - 1];

                    // Update flagged status
                    const flagCheckbox = qElement.querySelector(`#flag-${id}`);
                    if (flagCheckbox) {
                        question.isFlagged = flagCheckbox.checked;
                    }

                    // Update selected answers to store letters
                    const answerCheckboxes = qElement.querySelectorAll(`input[name="q${id}-ans"]:checked`);
                    question.selected = Array.from(answerCheckboxes).map(cb => cb.value);
                    
                    // Check if answered
                    question.isAnswered = question.selected.length > 0;
                });
                
                // Log quizState to console for debugging
                console.log(quizState);
            }

            // Dynamically set grid columns based on screen orientation
            function updateGridColumns() {
                if (window.innerWidth > window.innerHeight) {
                    // Landscape or desktop view
                    questionGrid.classList.remove('grid-cols-8');
                    questionGrid.classList.add('grid-cols-10');
                } else {
                    // Portrait view
                    questionGrid.classList.remove('grid-cols-10');
                    questionGrid.classList.add('grid-cols-8');
                }
            }

            // Handle page navigation
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    updateQuizState();
                    currentPage--;
                    renderQuestions();
                }
            });

            nextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(totalQuestions / questionsPerPage);
                if (currentPage < totalPages) {
                    updateQuizState();
                    currentPage++;
                    renderQuestions();
                }
            });

            // Handle dropdown for questions per page
            dropdownButton.addEventListener('click', () => {
                dropdownMenu.classList.toggle('hidden');
            });

            dropdownMenu.querySelectorAll('a').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    questionsPerPage = parseInt(e.target.dataset.count);
                    questionsPerPageDisplay.textContent = questionsPerPage;
                    currentPage = 1; // Reset to first page
                    updateQuizState();
                    renderQuestions();
                    dropdownMenu.classList.add('hidden');
                });
            });

            // Handle modal
            quickSelectBtn.addEventListener('click', () => {
                updateQuizState(); // Save current state before opening modal
                updateGridColumns(); // Update grid layout
                renderQuickSelectGrid();
                overlay.classList.remove('hidden');
                updateModalTimer();
            });

            closeModalBtn.addEventListener('click', () => {
                overlay.classList.add('hidden');
            });
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.add('hidden');
                }
            });

            questionGrid.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (target && target.hasAttribute('data-question-id')) {
                    const questionId = parseInt(target.getAttribute('data-question-id'));
                    const newPage = Math.ceil(questionId / questionsPerPage);
                    currentPage = newPage;
                    renderQuestions();
                    overlay.classList.add('hidden');
                }
            });

            // Handle form changes to update state
            quizContent.addEventListener('change', (e) => {
                updateQuizState();
            });

            // Timer functionality for main timer
            function startTimer() {
                timer = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    timerDisplay.textContent = formattedTime;
                    modalTimerDisplay.textContent = formattedTime; // Update modal timer as well

                    // Update timer color based on remaining time
                    if (timeLeft <= warningTime) {
                        timerDisplay.classList.add('red-text');
                        timerDisplay.classList.remove('blue-text');
                        modalTimerDisplay.classList.add('red-text');
                        modalTimerDisplay.classList.remove('blue-text');
                    } else {
                        timerDisplay.classList.add('blue-text');
                        timerDisplay.classList.remove('red-text');
                        modalTimerDisplay.classList.add('blue-text');
                        modalTimerDisplay.classList.remove('red-text');
                    }

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        // Optional: automatically submit the quiz
                        submitQuiz();
                    }
                }, 1000);
            }

            function updateModalTimer() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                modalTimerDisplay.textContent = formattedTime;
            }
            
            // Handle submit button click to show custom confirmation popup
            submitBtn.addEventListener('click', () => {
                updateQuizState(); // Save state one last time before showing popup
                const answeredCount = quizState.filter(q => q.selected.length > 0).length;
                const unansweredCount = quizState.filter(q => q.selected.length === 0).length;
                
                // Construct the summary message
                submitSummary.innerHTML = `
                    <p class="text-sm">T·ªïng s·ªë c√¢u h·ªèi: <b>${totalQuestions}</b></p>
                    <p class="text-sm">S·ªë c√¢u ƒë√£ tr·∫£ l·ªùi: <b>${answeredCount}</b></p>
                    <p class="text-sm">S·ªë c√¢u ch∆∞a tr·∫£ l·ªùi: <b>${unansweredCount}</b></p>
                `;
                submitOverlay.classList.remove('hidden');
            });

            // Handle submission confirmation from the popup
            submitYesBtn.addEventListener('click', () => {
                // Final submission logic goes here
                submitOverlay.classList.add('hidden');
                clearInterval(timer); // Stop the timer
                alert('B·∫°n ƒë√£ n·ªôp b√†i th√†nh c√¥ng!');
                // You might want to redirect or show a results page here
            });

            submitNoBtn.addEventListener('click', () => {
                // Hide the popup and continue the quiz
                submitOverlay.classList.add('hidden');
            });

            // Add resize listener for dynamic grid columns and button text
            window.addEventListener('resize', () => {
                updateGridColumns();
                // Re-evaluate display of elements based on new screen size
                const isMobileAfterResize = window.innerWidth < 640;
                const mobileHiddenElements = document.querySelectorAll('.mobile-hidden');
                if (isMobileAfterResize) {
                    mobileHiddenElements.forEach(el => el.style.display = 'none');
                    // Force questions per page to 3 on mobile resize
                    questionsPerPage = 3;
                    questionsPerPageDisplay.textContent = questionsPerPage;
                    renderQuestions();
                } else {
                    mobileHiddenElements.forEach(el => el.style.display = '');
                    // Force questions per page to 10 on desktop resize
                    questionsPerPage = 10;
                    questionsPerPageDisplay.textContent = questionsPerPage;
                    renderQuestions();
                }
            });

        });
    </script>
</body>
</html>
