<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√în t·∫≠p Tr·∫Øc nghi·ªám</title>
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --background-light: #e0f2f7;
      --text-dark: #333;
      --card-background: #ffffff;
      --shadow-light: rgba(0, 0, 0, 0.15);
      --border-light: #e0e0e0;
    }
    body {
      font-family: 'Times New Roman', Times, serif;
      background: linear-gradient(135deg, var(--background-light) 0%, #c1dce7 100%);
      margin: 0;
      padding: 20px;
      color: var(--text-dark);
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: var(--card-background);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    h1, h2, h3 {
      text-align: center;
      color: var(--secondary-color);
      margin-bottom: 25px;
      font-weight: normal;
    }
    h1 { font-size: 2.5em; }
    .selection-section {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 30px;
    }
    .card {
      background-color: var(--card-background);
      border-radius: 8px;
      box-shadow: 0 4px 15px var(--shadow-light);
      padding: 15px 25px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      width: 200px;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      border: 2px solid transparent;
      position: relative;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-light); }
    .card.selected { border-color: var(--primary-color); }
    .card h3 { margin:0; color:var(--text-dark); font-size:1.1em; font-weight:normal; }
    .trial-label {
      display: none;
      color: red;
      font-size: 0.9em;
      position: absolute;
      bottom: 5px;
      right: 10px;
    }
    .trial-label.show { display: block; }
    #topic-section { margin-top:40px; display:none; border-top:1px solid var(--border-light); padding-top:30px; }
    #quiz-section { margin-top:30px; border-top:1px solid var(--border-light); padding-top:25px; display:none; position:relative; }
    .question-card { margin-bottom:20px; padding:20px; border-radius:10px; background-color:#f9f9f9; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
    .question-card p.question-text { color:var(--primary-color); }
    .answers { display:flex; flex-direction:column; gap:10px; }
    .answer-label { display:flex; align-items:center; padding:12px 15px; border:1px solid var(--border-light); border-radius:8px; background-color:#fff; cursor:pointer; }
    .answer-label input[type="checkbox"] { margin-right:12px; }
    .quiz-controls { display:flex; justify-content:flex-end; margin-top:20px; gap:10px; }
    .quiz-controls button { padding:10px 20px; border:none; border-radius:5px; color:white; cursor:pointer; }
    #submit-btn { background-color:var(--primary-color); }
    #next-btn { background-color:var(--secondary-color); }
    #close-btn { position:absolute; top:15px; right:15px; background:#f44336; color:white; border:none; border-radius:50%; width:30px; height:30px; font-size:1.2em; cursor:pointer; display:none; }
    .correct {
      background-color: #4CAF50; /* M√†u xanh cho ƒë√°p √°n ƒë√∫ng */
      color: white;
    }
    .incorrect {
      background-color: #f44336; /* M√†u ƒë·ªè cho ƒë√°p √°n sai */
      color: white;
    }
    .icon {
      margin-left: 8px;
    }
    .correct .icon {
      color: green;
    }
    .incorrect .icon {
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="close-btn">&times;</button>
    <h1>√în t·∫≠p Tr·∫Øc nghi·ªám H·∫£i quan üìö</h1>

    <div id="subject-selection">
      <h2>Ch·ªçn m√¥n thi</h2>
      <div class="selection-section">
        <div class="card" data-subject="1">
          <h3>Ph√°p lu·∫≠t h·∫£i quan</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
        <div class="card" data-subject="2">
          <h3>K·ªπ thu·∫≠t nghi·ªáp v·ª• ngo·∫°i th∆∞∆°ng</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
        <div class="card" data-subject="3">
          <h3>K·ªπ thu·∫≠t nghi·ªáp v·ª• h·∫£i quan</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
      </div>
    </div>

    <div id="topic-section">
      <h2>Ch·ªçn lƒ©nh v·ª±c</h2>
      <div class="selection-section" id="topic-selection"></div>
    </div>

    <div id="quiz-section">
      <h2 id="quiz-title"></h2>
      <div id="quiz-questions"></div>
      <div class="quiz-controls">
        <button id="submit-btn">Tr·∫£ l·ªùi</button>
        <button id="next-btn">C√¢u ti·∫øp</button>
      </div>
    </div>
  </div>

  <script>
    let selectedAnswers = [];

    const subjectCards = document.querySelectorAll('#subject-selection .card');
    const topicSelectionSection = document.getElementById('topic-selection');
    const topicSection = document.getElementById('topic-section');
    const quizSection = document.getElementById('quiz-section');
    const quizTitle = document.getElementById('quiz-title');
    const quizQuestionsContainer = document.getElementById('quiz-questions');
    const nextBtn = document.getElementById('next-btn');
    const closeBtn = document.getElementById('close-btn');
    const submitBtn = document.getElementById('submit-btn');

    // ‚úÖ D·ªØ li·ªáu b·∫£n quy·ªÅn t·ª´ backend
    const ban_quyen = {{ ban_quyen|tojson }};

    // mapping m√£ m√¥n -> { m√£ lƒ©nh v·ª±c: t√™n lƒ©nh v·ª±c }
    const topics = {
      '1': {
        '11': 'Ph√°p lu·∫≠t h·∫£i quan',
        '12': 'Ch√≠nh s√°ch thu·∫ø',
        '13': 'Vi ph·∫°m h√†nh ch√≠nh'
      },
      '2': {
        '21': 'Giao nh·∫≠n v·∫≠n t·∫£i',
        '22': 'Ngo·∫°i th∆∞∆°ng',
        '23': 'Thanh to√°n qu·ªëc t·∫ø'
      },
      '3': {
        '31': 'Th·ªß t·ª•c h·∫£i quan',
        '32': 'Ch√≠nh s√°ch m·∫∑t h√†ng',
        '33': 'Tr·ªã gi√° h·∫£i quan',
        '34': 'Xu·∫•t x·ª© h√†ng h√≥a',
        '35': 'S·ªü h·ªØu tr√≠ tu·ªá',
        '36': 'Ph√¢n lo·∫°i h√†ng h√≥a'
      }
    };

    let usedQuestionIds = new Set();

    // ‚úÖ Hi·ªÉn th·ªã "d√πng th·ª≠" n·∫øu False
    subjectCards.forEach(card => {
      const monCode = card.dataset.subject;
      const trialLabel = card.querySelector('.trial-label');
      if (!ban_quyen[monCode]) {
        trialLabel.classList.add('show');
      }
    });

    function renderTopicCards(monCode) {
      topicSelectionSection.innerHTML = '';
      const topicList = topics[monCode] || {};
      Object.entries(topicList).forEach(([maMonThi, tenLinhVuc]) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.topic = maMonThi; 
        card.innerHTML = `<h3>${tenLinhVuc}</h3>`;
        card.addEventListener('click', () => {
          document.querySelectorAll('#topic-selection .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          usedQuestionIds.clear();
          startQuiz(maMonThi, tenLinhVuc);
        });
        topicSelectionSection.appendChild(card);
      });
      topicSection.style.display = 'block';
    }

    async function startQuiz(maMonThi, tenLinhVuc) {
      await loadNewQuestion(maMonThi, tenLinhVuc);
    }

    async function loadNewQuestion(maMonThi, tenLinhVuc) {
      try {
        const res = await fetch("/api/get-question", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ma_mon_thi: maMonThi, exclude_ids: Array.from(usedQuestionIds) })
        });
        const data = await res.json();
        if (!data.questions || data.questions.length === 0) {
          quizQuestionsContainer.innerHTML = "<p>Kh√¥ng c√≤n c√¢u h·ªèi n√†o cho lƒ©nh v·ª±c n√†y.</p>";
          quizSection.style.display = 'block';
          return;
        }
        let q = data.questions[0];
        usedQuestionIds.add(q.id);
        quizSection.style.display = 'block';
        quizTitle.textContent = tenLinhVuc;
        displayQuestion(q);
        closeBtn.style.display = 'block';
      } catch (err) {
        console.error("L·ªói khi t·∫£i c√¢u h·ªèi:", err);
        quizQuestionsContainer.innerHTML = "<p>L·ªói server!</p>";
      }
    }

    function displayQuestion(question) {
      quizQuestionsContainer.innerHTML = '';
      const questionCard = document.createElement('div');
      questionCard.className = 'question-card';
      questionCard.innerHTML = `<p class="question-text">${question.question}</p><div class="answers"></div>`;
      quizQuestionsContainer.appendChild(questionCard);
      const answersContainer = questionCard.querySelector('.answers');
      question.answers.forEach((answer, idx) => {
        if (answer && answer !== "NaN") {
          const label = document.createElement('label');
          label.className = 'answer-label';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = answer;
          checkbox.addEventListener('change', () => toggleAnswer(answer, checkbox));
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(answer));
          answersContainer.appendChild(label);
        }
      });
    }

    function toggleAnswer(answer, checkbox) {
      if (checkbox.checked) {
        selectedAnswers.push(answer);
      } else {
        selectedAnswers = selectedAnswers.filter(item => item !== answer);
      }
    }

    async function handleAnswer() {
      const currentQuestion = document.querySelector('.question-card');
      if (!currentQuestion) return;

      const res = await fetch("/api/get-question", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ma_mon_thi: currentQuestion.dataset.maMonThi,
          selected_answers: selectedAnswers
        })
      });
      const data = await res.json();

      const question = data.questions[0];
      displayAnswersWithResults(question);
    }

    function displayAnswersWithResults(question) {
      const answersContainer = document.querySelector('.answers');
      const correctAnswers = question.correct_answer.split(',');

      Array.from(answersContainer.children).forEach(label => {
        const answerValue = label.querySelector('input').value;
        if (correctAnswers.includes(answerValue)) {
          label.classList.add('correct');
          label.innerHTML += ' <span class="icon">‚úîÔ∏è</span>';
        } else if (selectedAnswers.includes(answerValue)) {
          label.classList.add('incorrect');
          label.innerHTML += ' <span class="icon">‚ùå</span>';
        }
      });

      const noteSection = document.getElementById('note-section');
      if (question.note) {
        noteSection.innerHTML = `<p>${question.note}</p>`;
        noteSection.style.display = 'block';
      } else {
        noteSection.style.display = 'none';
      }
    }

    submitBtn.addEventListener('click', handleAnswer);
    nextBtn.addEventListener('click', () => {
      const currentTopicCard = document.querySelector('#topic-selection .card.selected');
      if (currentTopicCard) {
        const maMonThi = currentTopicCard.dataset.topic;
        const tenLinhVuc = currentTopicCard.textContent.trim();
        loadNewQuestion(maMonThi, tenLinhVuc);
      }
    });

    closeBtn.addEventListener('click', () => {
      quizSection.style.display = 'none';
      quizQuestionsContainer.innerHTML = '';
      closeBtn.style.display = 'none';
      usedQuestionIds.clear();
    });

    subjectCards.forEach(card => {
      card.addEventListener('click', () => {
        subjectCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        const monCode = card.dataset.subject;
        renderTopicCards(monCode);
        quizSection.style.display = 'none';
        quizQuestionsContainer.innerHTML = '';
        setTimeout(() => { topicSection.scrollIntoView({ behavior: 'smooth' }); }, 300);
      });
    });
  </script>
</body>
</html>
