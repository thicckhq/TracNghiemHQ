<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ôn tập</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .cards-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .card {
            position: relative;
            background: #fdfdfd;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            cursor: pointer;
            width: 250px;
            text-align: center;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .trial-label {
            display: none;
            position: absolute;
            bottom: 8px;
            right: 10px;
            font-size: 13px;
            color: red;
            font-weight: bold;
        }
        .trial-label.show {
            display: inline;
        }
        #quiz-section {
            display: none;
            margin-top: 20px;
        }
        #question {
            margin-bottom: 20px;
        }
        .option {
            margin: 10px 0;
            padding: 10px;
            background: #eee;
            border-radius: 5px;
            cursor: pointer;
        }
        .option.correct { background-color: #c8f7c5; }
        .option.incorrect { background-color: #f7c5c5; }
        #note {
            margin-top: 10px;
            font-style: italic;
            color: #333;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-secondary { background: #6c757d; color: #fff; }
    </style>
</head>
<body>
<div class="container">
    <h1>Ôn tập</h1>

    <!-- Phần chọn môn -->
    <div id="subject-selection">
        <h2>Chọn môn thi</h2>
        <div class="cards-container">
            <div class="card" data-subject="phap_luat_hai_quan">
                Pháp luật hải quan
                <span class="trial-label">(dùng thử)</span>
            </div>
            <div class="card" data-subject="ky_thuat_nghiep_vu_ngoai_thuong">
                Kỹ thuật nghiệp vụ ngoại thương
                <span class="trial-label">(dùng thử)</span>
            </div>
            <div class="card" data-subject="ky_thuat_nghiep_vu_hai_quan">
                Nghiệp vụ hải quan
                <span class="trial-label">(dùng thử)</span>
            </div>
        </div>
    </div>

    <!-- Phần quiz -->
    <div id="quiz-section">
        <h2 id="quiz-title">Ôn tập</h2>
        <div id="question"></div>
        <div id="options"></div>
        <div id="note"></div>
        <button id="next-btn" class="btn btn-primary">Câu tiếp theo</button>
        <button id="back-btn" class="btn btn-secondary">Quay lại chọn môn</button>
    </div>
</div>

<script>
  const subjectCards = document.querySelectorAll('#subject-selection .card');
  const subjectSelection = document.getElementById('subject-selection');
  const quizSection = document.getElementById('quiz-section');
  const questionEl = document.getElementById('question');
  const optionsEl = document.getElementById('options');
  const noteEl = document.getElementById('note');
  const nextBtn = document.getElementById('next-btn');
  const backBtn = document.getElementById('back-btn');

  let currentSubject = null;
  let currentQuestionIndex = 0;
  let questions = [];

  // ✅ Dữ liệu bản quyền từ server
  const ban_quyen = {{ ban_quyen|tojson }};

  const subjectMap = {
    "phap_luat_hai_quan": "1",
    "ky_thuat_nghiep_vu_ngoai_thuong": "2",
    "ky_thuat_nghiep_vu_hai_quan": "3"
  };

  // ✅ Hiển thị nhãn (dùng thử) nếu False
  subjectCards.forEach(card => {
    const subject = card.dataset.subject;
    const monCode = subjectMap[subject];
    const trialLabel = card.querySelector('.trial-label');
    if (!ban_quyen[monCode]) {
      trialLabel.classList.add('show');
    }
  });

  // Event chọn môn
  subjectCards.forEach(card => {
    card.addEventListener('click', () => {
      currentSubject = card.dataset.subject;
      startQuiz();
    });
  });

  backBtn.addEventListener('click', () => {
    quizSection.style.display = "none";
    subjectSelection.style.display = "block";
    questions = [];
    currentQuestionIndex = 0;
  });

  nextBtn.addEventListener('click', () => {
    currentQuestionIndex++;
    if (currentQuestionIndex < questions.length) {
      showQuestion();
    } else {
      alert("Bạn đã hoàn thành các câu hỏi!");
      quizSection.style.display = "none";
      subjectSelection.style.display = "block";
    }
  });

  async function startQuiz() {
    subjectSelection.style.display = "none";
    quizSection.style.display = "block";
    document.getElementById("quiz-title").innerText = "Môn: " + currentSubject;

    const monCode = subjectMap[currentSubject];

    try {
      const res = await fetch("/api/get-question", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mon: monCode })
      });

      const data = await res.json();
      if (data.error) {
        alert(data.error);
        quizSection.style.display = "none";
        subjectSelection.style.display = "block";
        return;
      }

      questions = data.questions || [];
      currentQuestionIndex = 0;
      if (questions.length > 0) {
        showQuestion();
      } else {
        alert("Không có câu hỏi nào!");
        quizSection.style.display = "none";
        subjectSelection.style.display = "block";
      }
    } catch (err) {
      console.error(err);
      alert("Lỗi khi tải câu hỏi!");
      quizSection.style.display = "none";
      subjectSelection.style.display = "block";
    }
  }

  function showQuestion() {
    const q = questions[currentQuestionIndex];
    questionEl.innerText = q.noi_dung;
    optionsEl.innerHTML = "";

    const answers = ["A","B","C","D"];
    answers.forEach(ans => {
      if (q[ans]) {
        const div = document.createElement("div");
        div.classList.add("option");
        div.innerText = ans + ". " + q[ans];
        div.addEventListener("click", () => {
          if (q.dap_an_dung.includes(ans)) {
            div.classList.add("correct");
          } else {
            div.classList.add("incorrect");
          }
          if (q.ghi_chu) {
            noteEl.innerText = "Ghi chú: " + q.ghi_chu;
          } else {
            noteEl.innerText = "";
          }
        });
        optionsEl.appendChild(div);
      }
    });

    noteEl.innerText = "";
  }
</script>
</body>
</html>
