<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√în t·∫≠p Tr·∫Øc nghi·ªám</title>
  <style>
    body {
      font-family: 'Times New Roman', serif;
      background: #f2f9ff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #2b6cb0;
    }
    .selection-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    .card {
      position: relative;
      background: #fff;
      border-radius: 8px;
      padding: 15px 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
      width: 220px;
      text-align: center;
    }
    .card:hover {
      transform: translateY(-4px);
    }
    .card h3 {
      margin: 0;
      font-size: 1.1em;
    }
    /* Nh√£n d√πng th·ª≠ */
    .trial-label {
      color: red;
      font-size: 0.85em;
      font-style: italic;
      position: absolute;
      bottom: 5px;
      right: 8px;
      display: none;
    }
    .trial-label.show { display: block; }

    /* Quiz section */
    #quiz-section {
      margin-top: 30px;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      display: none;
    }
    #question {
      font-weight: bold;
      margin-bottom: 15px;
    }
    .option {
      display: block;
      margin: 8px 0;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      cursor: pointer;
      transition: background 0.2s;
    }
    .option:hover {
      background: #f1f1f1;
    }
    .option.correct {
      background: #d4edda;
      border-color: #28a745;
    }
    .option.wrong {
      background: #f8d7da;
      border-color: #dc3545;
    }
    #note {
      margin-top: 15px;
      font-style: italic;
      color: #555;
    }
    .hidden { display: none; }
    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 15px;
    }
    .btn-primary {
      background: #2b6cb0;
      color: #fff;
    }
    .btn-secondary {
      background: #e2e8f0;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>√în t·∫≠p Tr·∫Øc nghi·ªám H·∫£i quan üìö</h1>

    <div id="subject-selection">
      <h2>Ch·ªçn m√¥n thi</h2>
      <div class="selection-section">
        <div class="card" data-subject="phap_luat_hai_quan">
          <h3>Ph√°p lu·∫≠t h·∫£i quan</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
        <div class="card" data-subject="ky_thuat_nghiep_vu_ngoai_thuong">
          <h3>K·ªπ thu·∫≠t nghi·ªáp v·ª• ngo·∫°i th∆∞∆°ng</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
        <div class="card" data-subject="ky_thuat_nghiep_vu_hai_quan">
          <h3>K·ªπ thu·∫≠t nghi·ªáp v·ª• h·∫£i quan</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
      </div>
    </div>

    <div id="quiz-section">
      <h2 id="quiz-title">C√¢u h·ªèi</h2>
      <div id="trial-warning" class="hidden"
           style="color:red; font-weight:bold; margin-bottom:10px;">
        B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô d√πng th·ª≠, ch·ªâ c√≥ 5 c√¢u h·ªèi.<br>
        H√£y ƒêƒÉng k√Ω/Gia h·∫°n ƒë·ªÉ √în t·∫≠p ƒë·∫ßy ƒë·ªß k√®m theo flashcard
      </div>
      <div id="question"></div>
      <div id="options"></div>
      <div id="note" class="hidden"></div>
      <button id="next-btn" class="btn btn-primary hidden">C√¢u ti·∫øp</button>
      <button id="back-btn" class="btn btn-secondary hidden">Quay l·∫°i ch·ªçn m√¥n</button>
    </div>
  </div>

  <script>
    const subjectCards = document.querySelectorAll('#subject-selection .card');
    const subjectSelection = document.getElementById('subject-selection');
    const quizSection = document.getElementById('quiz-section');
    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const noteEl = document.getElementById('note');
    const nextBtn = document.getElementById('next-btn');
    const backBtn = document.getElementById('back-btn');
    const trialWarning = document.getElementById('trial-warning');

    let currentSubject = null;
    let currentQuestionIndex = 0;
    let questions = [];

    // D·ªØ li·ªáu t·ª´ server
    const mon_dang_ky = {{ mon_dang_ky|tojson }};
    const mon_het_han = {{ mon_het_han|tojson }};

    const subjectMap = {
      "phap_luat_hai_quan": "1",
      "ky_thuat_nghiep_vu_ngoai_thuong": "2",
      "ky_thuat_nghiep_vu_hai_quan": "3"
    };

    // H√†m ki·ªÉm tra trial
    function isTrial(subject) {
      const monCode = subjectMap[subject];
      return (!mon_dang_ky.includes(monCode) || mon_het_han.includes(monCode));
    }

    // Hi·ªÉn th·ªã nh√£n (d√πng th·ª≠) tr√™n card
    subjectCards.forEach(card => {
      const subject = card.dataset.subject;
      const monCode = subjectMap[subject];
      const trialLabel = card.querySelector('.trial-label');

      if (!mon_dang_ky.includes(monCode) || mon_het_han.includes(monCode)) {
        trialLabel.classList.add('show');
      } else {
        trialLabel.classList.remove('show');
      }
    });

    // X·ª≠ l√Ω ch·ªçn m√¥n
    subjectCards.forEach(card => {
      card.addEventListener('click', () => {
        currentSubject = card.dataset.subject;

        if (isTrial(currentSubject)) {
          trialWarning.classList.remove("hidden");
        } else {
          trialWarning.classList.add("hidden");
        }

        startQuiz(currentSubject);
      });
    });

    function startQuiz(subject) {
      subjectSelection.style.display = 'none';
      quizSection.style.display = 'block';
      loadQuestions(subject);
    }

    function loadQuestions(subject) {
      // Create a mapping from data-subject to a Vietnamese topic name
      const subjectTopicMap = {
        "phap_luat_hai_quan": "Ph√°p lu·∫≠t h·∫£i quan",
        "ky_thuat_nghiep_vu_ngoai_thuong": "K·ªπ thu·∫≠t nghi·ªáp v·ª• ngo·∫°i th∆∞∆°ng",
        "ky_thuat_nghiep_vu_hai_quan": "K·ªπ thu·∫≠t nghi·ªáp v·ª• h·∫£i quan"
      };

      const topicName = subjectTopicMap[subject];
      if (!topicName) {
        console.error("Lƒ©nh v·ª±c kh√¥ng h·ª£p l·ªá:", subject);
        return;
      }

      fetch('/api/get-question', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ten_mon_thi: topicName })
      })
      .then(res => {
        if (!res.ok) {
          throw new Error('L·ªói khi l·∫•y c√¢u h·ªèi');
        }
        return res.json();
      })
      .then(data => {
        if (data.error) {
          alert("L·ªói: " + data.error);
          return;
        }
        questions = data.questions;
        if (isTrial(subject) && questions.length > 5) {
          questions = questions.slice(0, 5); // Gi·ªõi h·∫°n 5 c√¢u cho ch·∫ø ƒë·ªô d√πng th·ª≠
        }
        currentQuestionIndex = 0;
        showQuestion();
      })
      .catch(error => {
        console.error('Fetch error:', error);
        alert('Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi. Vui l√≤ng th·ª≠ l·∫°i sau.');
      });
    }

    function showQuestion() {
      const q = questions[currentQuestionIndex];
      questionEl.textContent = q.noi_dung;
      optionsEl.innerHTML = '';
      noteEl.classList.add('hidden');
      nextBtn.classList.add('hidden');
      backBtn.classList.add('hidden');

      q.dap_an.forEach((opt, i) => {
        if (!opt) return; // ·∫©n n·∫øu tr·ªëng
        const btn = document.createElement('div');
        btn.classList.add('option');
        btn.textContent = opt;
        btn.addEventListener('click', () => selectAnswer(btn, i, q));
        optionsEl.appendChild(btn);
      });
    }

    function selectAnswer(btn, index, q) {
      const correctAnswers = q.dap_an_dung.split('');
      const isCorrect = correctAnswers.includes(String.fromCharCode(65 + index));

      if (isCorrect) {
        btn.classList.add('correct');
      } else {
        btn.classList.add('wrong');
      }

      Array.from(optionsEl.children).forEach((child, i) => {
        const ansChar = String.fromCharCode(65 + i);
        if (correctAnswers.includes(ansChar)) {
          child.classList.add('correct');
        }
        child.style.pointerEvents = 'none';
      });

      if (q.ghi_chu) {
        noteEl.textContent = "Ghi ch√∫: " + q.ghi_chu;
        noteEl.classList.remove('hidden');
      }

      nextBtn.classList.remove('hidden');
      backBtn.classList.remove('hidden');
    }

    nextBtn.addEventListener('click', () => {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        showQuestion();
      } else {
        alert("B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi!");
        subjectSelection.style.display = 'block';
        quizSection.style.display = 'none';
      }
    });

    backBtn.addEventListener('click', () => {
      subjectSelection.style.display = 'block';
      quizSection.style.display = 'none';
    });
  </script>
</body>
</html>
