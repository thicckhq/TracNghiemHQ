<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√în t·∫≠p Tr·∫Øc nghi·ªám</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #007bff; /* M√†u xanh d∆∞∆°ng ch·ªß ƒë·∫°o */
      --secondary-color: #28a745; /* M√†u xanh l√° cho th√†nh c√¥ng */
      --incorrect-color: #dc3545; /* M√†u ƒë·ªè cho l·ªói */
      --background-light: #f8f9fa; /* N·ªÅn tr·∫Øng x√°m */
      --background-card: #FFFFFF; /* N·ªÅn th·∫ª tr·∫Øng */
      --text-dark: #212529; /* Ch·ªØ ƒëen */
      --text-light: #6c757d; /* Ch·ªØ x√°m */
      --border-color: #e9ecef; /* Vi·ªÅn x√°m nh·∫°t */
      --shadow-soft: 0 8px 16px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 12px 24px rgba(0, 0, 0, 0.15);
    }
    body {
      font-family: 'Times New Roman', Times, serif;
      background: linear-gradient(135deg, var(--background-light) 0%, #e0e7ee 100%);
      margin: 0; padding: 40px 20px;
      color: var(--text-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
	font-size: 1em; /* nh·ªè h∆°n m·∫∑c ƒë·ªãnh */
    }
    .container {
      max-width: 1000px;
	font-size: 1em;
      margin: 0 auto;
      background: var(--background-card);
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--shadow-hover);
      position: relative;
      transition: box-shadow 0.3s ease-in-out;
    }
    .container:hover {
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    h1, h2, h3 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 2em;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
    }
    h2 { font-size: 1.5em; }

    h3 { font-size: 1.2em; font-weight: normal; } /* ƒê√£ thay ƒë·ªïi font-weight */
	
    .selection-section {
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:25px;
      margin-top:20px;
    }
    .card{
      background:var(--background-card);
      border-radius:20px;
      box-shadow:var(--shadow-soft);
      padding:30px;
      text-align:center;
      cursor:pointer;
      transition:transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      flex-basis: 250px;
      border: 3px solid transparent;
      position: relative;
    }


    .card:hover{
      transform: translateY(-10px);
      box-shadow:var(--shadow-hover);
    }


    .card.selected{
      border-color: var(--primary-color);
      transform: scale(1.05);
      background: #f0f8ff;
    }
    .card h3{ margin:0; color:var(--text-dark); }
    .trial-label{
	font-weight: normal;
      font-size:.9em;
      position:absolute;
      bottom:10px;
      right:15px;
      color: red;
      font-weight: 700;
      letter-spacing: 0.5px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }

    #topic-section{ margin-top:40px; display:none; border-top:1px solid var(--border-color); padding-top:30px; }
    #quiz-section{ margin-top:30px; display:none; border-top:1px solid var(--border-color); padding-top:25px; position:relative; }

    .question-card{
      margin-bottom:20px;
      padding: 0px;
      border:none;
      background:transparent;
      box-shadow:none;
      margin: 0 0 8px 0;
    }
    .question-card p.question-text{
      color:var(--text-dark);
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 8px;
	line-height: 1.4;
    }

    .answers{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .answer-label{
      display:flex;
  	align-items:left;
  	font-size: 16px;
  	gap:6px;
  	padding:4px 6px;
  	border:none;
  	background:none;
  	cursor:pointer;
  	transition:background-color 0.2s, border-color 0.2s, transform 0.1s;
  	font-weight: normal; /* b·ªè in ƒë·∫≠m */
  	color: var(--text-dark);
    }
    .answer-label:hover {
      background: #f8f9fa;
      border-color: #d0d0d0;
      transform: translateY(-2px);
    }
    .answer-left { display:flex; align-items:center; gap:12px; }
    .answer-label input[type="checkbox"]{
      width:15px;
      height:15px;
      accent-color: var(--primary-color);
    }

    .quiz-controls{ display:flex; justify-content:flex-end; margin-top:30px; gap:20px; }
    .quiz-controls button{
      padding:15px 30px;
      border:none;
      border-radius:12px;
      color:#fff;
      cursor:pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: background-color 0.3s, transform 0.1s;
      box-shadow: var(--shadow-soft);
    }
    #submit-btn{ background:var(--primary-color); }
    #submit-btn:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    #next-btn{ background:var(--secondary-color); }
    #next-btn:hover { background: #1e7e34; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    

    .correct{
      background-color:#e6f3e7;
      border-color:var(--secondary-color);
      font-weight: 600;
      color: #1e7e34;
    }
    .incorrect{
      background-color:#ffebeb;
      border-color:var(--incorrect-color);
      font-weight: 600;
      color: #dc3545;
    }
    .icon{ margin-left:12px; font-size: 1.2rem; }
    .icon.ok{ color:#2e7d32; }
    .icon.no{ color:#c62828; }

    #note-section{
      margin-top:30px;
      display:none;
      background:#e7f3ff;
      border-left:6px solid var(--primary-color);
      padding:20px;
      border-radius:12px;
      font-size: 1rem;
      color: var(--text-dark);
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    #note-section h4{
      margin:0 0 10px 0;
      color: var(--primary-color);
      font-weight:700;
      font-size: 1.1rem;
    }
.answer-result {
      margin-top: 15px;
      font-size: 1.1em;
      font-weight: bold;
      text-align: center;
      display: none;
    }
    .answer-result.correct {
      color: #27ae60;
      animation: bounce 0.6s ease;
    }
    .answer-result.incorrect {
      color: #e74c3c;
      animation: shake 0.6s ease;
    }
    @keyframes bounce {
      0%,100% { transform: translateY(0);}
      50% { transform: translateY(-8px);}
    }
    @keyframes shake {
      0%{transform:translateX(0);}
      25%{transform:translateX(-5px);}
      50%{transform:translateX(5px);}
      75%{transform:translateX(-5px);}
      100%{transform:translateX(0);}
    }
    .question-note {
      margin-top: 10px;
      font-size: 0.95em;
      color: #555;
      background: #f9f9f9;
      padding: 8px 12px;
      border-left: 4px solid #3498db;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <h1>√în t·∫≠p Tr·∫Øc nghi·ªám H·∫£i quan üìö</h1>

    <div id="subject-selection">
      <h2>Ch·ªçn m√¥n thi</h2>
      <div class="selection-section">
        <div class="card" data-subject="1">
          <h3>Ph√°p lu·∫≠t h·∫£i quan</h3>
          <span class="trial-label">D√πng th·ª≠</span>
        </div>
        <div class="card" data-subject="2">
          <h3>K·ªπ thu·∫≠t nghi·ªáp v·ª• ngo·∫°i th∆∞∆°ng</h3>
          <span class="trial-label">D√πng th·ª≠</span>
        </div>
        <div class="card" data-subject="3">
          <h3>K·ªπ thu·∫≠t nghi·ªáp v·ª• h·∫£i quan</h3>
          <span class="trial-label">D√πng th·ª≠</span>
        </div>
      </div>
    </div>

    <div id="topic-section">
      <h2>Ch·ªçn lƒ©nh v·ª±c</h2>
      <div class="selection-section" id="topic-selection"></div>
    </div>

    <div id="quiz-section" style="display:none; margin-top:16px;">
	<!-- B·ªô ƒë·∫øm ƒê√∫ng/Sai -->
      <h2 id="topic-title" style="margin-bottom:8px; text-align:center;">
    <span id="topic-name"></span>
    <span id="score-tracker" style="margin-left: 12px; font-size:14px; font-weight:500;">
      <span id="correct-count" style="color:green;">ƒê√∫ng 0</span> | 
      <span id="wrong-count" style="color:red;">0 Sai</span>
    	</span>
  	</h2>

  	<div id="quiz-questions"></div>

  	<div id="note-section">
	
        <h4>Ghi ch√∫</h4>
        <div id="note-text"></div>
      </div>
      <div class="quiz-controls">
        <button id="submit-btn">Tr·∫£ l·ªùi</button>
        <button id="next-btn">C√¢u ti·∫øp</button>
      </div>
	<div id="answer-result" class="answer-result"></div>
    	<div id="question-note" class="question-note"></div>
    </div>


  </div>

  <script>
    // ====== Bi·∫øn tr·∫°ng th√°i ======
    let selectedAnswers = [];            // M·∫£ng key A/B/C/D ƒëang ƒë∆∞·ª£c ch·ªçn
    let usedQuestionIds = new Set();     // Id c√¢u h·ªèi ƒë√£ d√πng ƒë·ªÉ lo·∫°i tr·ª´
    let currentQuestion = null;          // L∆∞u c√¢u h·ªèi hi·ªán t·∫°i (ƒë·ªÉ ch·∫•m tr√™n client)
    let currentTopic = null;
	let correctCount = 0;
    let wrongCount = 0;
	 // Hi·ªÉn th·ªã b·ªô ƒë·∫øm
    function updateScore() {
      document.getElementById("correct-count").textContent = "ƒê√∫ng " + correctCount;
      document.getElementById("wrong-count").textContent = wrongCount + " Sai";
    }
    // C√°c ph·∫ßn t·ª≠ DOM
    const subjectCards = document.querySelectorAll('#subject-selection .card');
    const topicSelectionSection = document.getElementById('topic-selection');
    const topicSection = document.getElementById('topic-section');
    const quizSection = document.getElementById('quiz-section');
    const quizTitle = document.getElementById('quiz-title');
    const quizQuestionsContainer = document.getElementById('quiz-questions');
    const nextBtn = document.getElementById('next-btn');
    //const closeBtn = document.getElementById('close-btn');
    const submitBtn = document.getElementById('submit-btn');
    const noteWrap = document.getElementById('note-section');
    const noteText = document.getElementById('note-text');

    // D·ªØ li·ªáu b·∫£n quy·ªÅn render t·ª´ backend (n·∫øu kh√¥ng c√≥, m·∫∑c ƒë·ªãnh all false ƒë·ªÉ kh√¥ng l·ªói)
    const ban_quyen = (typeof {{ ban_quyen|tojson if ban_quyen is defined else "null" }} !== 'undefined' && {{ ban_quyen|tojson if ban_quyen is defined else "null" }}) || { "1": false, "2": false, "3": false };

    // mapping m√£ m√¥n -> { m√£ lƒ©nh v·ª±c: t√™n lƒ©nh v·ª±c }
    const topics = {
      '1': { '11': 'Ph√°p lu·∫≠t h·∫£i quan', '12': 'Ch√≠nh s√°ch thu·∫ø', '13': 'Vi ph·∫°m h√†nh ch√≠nh' },
      '2': { '21': 'Giao nh·∫≠n v·∫≠n t·∫£i', '22': 'Ngo·∫°i th∆∞∆°ng', '23': 'Thanh to√°n qu·ªëc t·∫ø' },
      '3': { '31': 'Th·ªß t·ª•c h·∫£i quan', '32': 'Ch√≠nh s√°ch m·∫∑t h√†ng', '33': 'Tr·ªã gi√° h·∫£i quan', '34': 'Xu·∫•t x·ª© h√†ng h√≥a', '35': 'S·ªü h·ªØu tr√≠ tu·ªá', '36': 'Ph√¢n lo·∫°i h√†ng h√≥a' }
    };

    // Hi·ªÉn th·ªã nh√£n "D√πng th·ª≠"
    subjectCards.forEach(card => {
      const monCode = card.dataset.subject;
      const trialLabel = card.querySelector('.trial-label');
      if (ban_quyen[monCode]) trialLabel.style.display = 'none';
    });

    // Render c√°c th·∫ª lƒ©nh v·ª±c
    function renderTopicCards(monCode) {
      topicSelectionSection.innerHTML = '';
      const topicList = topics[monCode] || {};
      Object.entries(topicList).forEach(([maMonThi, tenLinhVuc]) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.topic = maMonThi; // 11,12,13,21...
        card.innerHTML = `<h3>${tenLinhVuc}</h3>`;
        card.addEventListener('click', () => {
          document.querySelectorAll('#topic-selection .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          usedQuestionIds.clear();
          currentTopic = { code: maMonThi, name: tenLinhVuc };
	
      //loadNewQuestion(maMonThi, tenLinhVuc);
          startQuiz(maMonThi, tenLinhVuc);
        });
        topicSelectionSection.appendChild(card);
      });
      topicSection.style.display = 'block';
    }

    // B·∫Øt ƒë·∫ßu quiz cho m·ªôt lƒ©nh v·ª±c
    function startQuiz(maMonThi, tenLinhVuc) {
      currentTopic = { code: maMonThi, name: tenLinhVuc };
      correctCount = 0;
      wrongCount = 0;
      updateScore();

      document.getElementById("topic-name").textContent = tenLinhVuc;
      document.getElementById("quiz-section").style.display = "block";
      document.getElementById("score-tracker").style.display = "block";

      usedQuestionIds.clear();
      loadNewQuestion(maMonThi, tenLinhVuc);

      // cu·ªôn xu·ªëng v√πng quiz
      document.getElementById("quiz-section").scrollIntoView({
        behavior: "smooth",
        block: "start"
      });

    }

    // T·∫£i c√¢u h·ªèi m·ªõi t·ª´ backend
    async function loadNewQuestion(maMonThi, tenLinhVuc) {
      try {
        selectedAnswers = [];
        noteWrap.style.display = 'none';
        noteText.textContent = '';

        const res = await fetch("/api/get-question", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ma_mon_thi: maMonThi,
            exclude_ids: Array.from(usedQuestionIds)
          })
        });

        // N·∫øu backend tr·∫£ v·ªÅ l·ªói HTML, parse JSON s·∫Ω l·ªói ‚Äî x·ª≠ l√Ω an to√†n
        let data = null;
        try { data = await res.json(); } catch(e) { data = null; }

        if (!data || !data.questions || data.questions.length === 0) {
          quizQuestionsContainer.innerHTML = "<p>Kh√¥ng c√≤n c√¢u h·ªèi cho lƒ©nh v·ª±c n√†y ho·∫∑c l·ªói m√°y ch·ªß.</p>";
          quizSection.style.display = 'block';
          quizTitle.textContent = tenLinhVuc || '√în t·∫≠p';
          return;
        }

        const q = data.questions[0];
        currentQuestion = normalizeQuestion(q); // Chu·∫©n h√≥a keys/text
        usedQuestionIds.add(currentQuestion.id);

        quizTitle.textContent = tenLinhVuc || '√în t·∫≠p';
        displayQuestion(currentQuestion);
        quizSection.style.display = 'block';
      } catch (err) {
        console.error("L·ªói khi t·∫£i c√¢u h·ªèi:", err);
        quizQuestionsContainer.innerHTML = "<p>L·ªói server!</p>";
        quizSection.style.display = 'block';
      }
    }

    // Chu·∫©n h√≥a question: b·∫£o ƒë·∫£m answers c√≥ key l√† A/B/C/D
    function normalizeQuestion(q) {
      // q.answers c√≥ th·ªÉ c√≥ key d·∫°ng "dap_an_a" ... => map sang A/B/C/D
      const mapKey = (k) => {
        if (!k) return '';
        const last = k.slice(-1).toUpperCase();
        return ['A','B','C','D'].includes(last) ? last : k.toUpperCase();
      };
      const answers = (q.answers || [])
        .map(a => ({ key: mapKey(a.key), text: a.text }))
        .filter(a => a.text && String(a.text).trim() !== '' && String(a.text).trim() !== 'NaN' && ['A','B','C','D'].includes(a.key));

      // correct_answer: "A" ho·∫∑c "ABCD" -> set k√Ω t·ª± duy nh·∫•t
      const rawCorrect = (q.correct_answer || '').toString().toUpperCase();
      const correctSet = new Set(rawCorrect.split('').filter(ch => ['A','B','C','D'].includes(ch)));

      // note: ·∫©n n·∫øu tr·ªëng/NaN
      const note = (q.note || '').toString().trim();
      const safeNote = (note && note !== 'NaN') ? note : '';

      return {
        id: q.id,
        question: q.question || q.cau_hoi || '',
        answers,
        correct_answer: Array.from(correctSet).join(''), // ƒë√£ lo·∫°i tr√πng
        note: safeNote
      };
    }

    // Hi·ªÉn th·ªã c√¢u h·ªèi + ƒë√°p √°n
    function displayQuestion(question) {
      quizQuestionsContainer.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'question-card';
      wrap.dataset.maMonThi = currentTopic.code || '';
	
	// reset k·∫øt qu·∫£ tr∆∞·ªõc ƒë√≥
      const answerResultDiv = document.getElementById("answer-result");
      const noteDiv = document.getElementById("question-note");
      answerResultDiv.style.display = "none";
      answerResultDiv.textContent = "";
      noteDiv.style.display = "none";
      noteDiv.textContent = "";

      const html = `
        <p class="question-text">${question.question || ''}</p>
        <div class="answers"></div>
      `;
      wrap.innerHTML = html;
      quizQuestionsContainer.appendChild(wrap);

      const answersContainer = wrap.querySelector('.answers');
      question.answers.forEach(ans => {
        const label = document.createElement('label');
        label.className = 'answer-label';
        label.dataset.key = ans.key;

        const left = document.createElement('div');
        left.className = 'answer-left';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = ans.key; // GI√Å TR·ªä = A/B/C/D ƒë·ªÉ so s√°nh chu·∫©n
        cb.addEventListener('change', () => toggleAnswer(ans.key, cb));

       

        const textSpan = document.createElement('span');
        textSpan.textContent = ans.text;

        left.appendChild(cb);
        left.appendChild(textSpan);

        const right = document.createElement('span');
        right.className = 'icon';

        label.appendChild(left);
        label.appendChild(right);
        answersContainer.appendChild(label);
      });
    }

    // Qu·∫£n l√Ω ch·ªçn/b·ªè ch·ªçn ƒë√°p √°n
    function toggleAnswer(key, checkbox) {
      if (checkbox.checked) {
        if (!selectedAnswers.includes(key)) selectedAnswers.push(key);
      } else {
        selectedAnswers = selectedAnswers.filter(k => k !== key);
      }
    }

    // Ch·∫•m ƒëi·ªÉm tr√™n client (kh√¥ng g·ªçi API)
    function handleAnswer() {
  if (!currentQuestion) return;

  const selectedEls = document.querySelectorAll(".answer-label input:checked");
  const selectedKeys = Array.from(selectedEls).map(el => el.value).sort();
  const userAnswer = selectedKeys.join("");
  const correctAnswer = currentQuestion.correct_answer;
const answerResultDiv = document.getElementById("answer-result");
  const noteDiv = document.getElementById("question-note");

  // Hi·ªÉn th·ªã k·∫øt qu·∫£
  if (userAnswer === correctAnswer) {
    answerResultDiv.textContent = "üéâ Tuy·ªát v·ªùi! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng!";
    answerResultDiv.className = "answer-result correct";
  } else {
    answerResultDiv.textContent = "üòÖ R·∫•t ti·∫øc, ch∆∞a ch√≠nh x√°c. C·ªë g·∫Øng th√™m nh√©!";
    answerResultDiv.className = "answer-result incorrect";
  }
  answerResultDiv.style.display = "block";

  // Hi·ªán ghi ch√∫ n·∫øu c√≥
  if (currentQuestion.note) {
    noteDiv.textContent = "üìå " + currentQuestion.note;
    noteDiv.style.display = "block";
  } else {
    noteDiv.style.display = "none";
  }

  // Highlight ƒë√°p √°n
  document.querySelectorAll(".answer-label").forEach(el => {
    const key = el.dataset.key;
    const rightIcon = el.querySelector(".icon");
    if (correctAnswer.includes(key)) {
      el.classList.add("correct");
      rightIcon.textContent = "‚úî";
      rightIcon.style.color = "#28a745";
    }
    if (selectedKeys.includes(key) && !correctAnswer.includes(key)) {
      el.classList.add("incorrect");
      rightIcon.textContent = "‚ùå";
      rightIcon.style.color = "#dc3545";
    }
  });
}



    // C√¢u ti·∫øp
    function handleNext() {
      const cur = document.querySelector('#topic-selection .card.selected');
      if (!cur) return;
      const maMonThi = cur.dataset.topic;
      const tenLinhVuc = cur.textContent.trim();
      loadNewQuestion(maMonThi, tenLinhVuc);
    }

    // ƒê√≥ng kh·ªëi quiz
    function handleClose() {
      quizSection.style.display = 'none';
      quizQuestionsContainer.innerHTML = '';
      noteWrap.style.display = 'none';
      noteText.textContent = '';
      closeBtn.style.display = 'none';
      selectedAnswers = [];
      currentQuestion = null;
      usedQuestionIds.clear();
      document.querySelector('#topic-selection .card.selected')?.classList.remove('selected');
      document.querySelector('#subject-selection .card.selected')?.classList.remove('selected');
      topicSection.style.display = 'none';
    }

    // G√°n s·ª± ki·ªán
    submitBtn.addEventListener('click', handleAnswer);
    nextBtn.addEventListener('click', handleNext);
    //closeBtn.addEventListener('click', handleClose);

    subjectCards.forEach(card => {
      card.addEventListener('click', () => {
        subjectCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        const monCode = card.dataset.subject;
        renderTopicCards(monCode);
	quizSection.style.display = 'none';
	quizQuestionsContainer.innerHTML = '';
	usedQuestionIds.clear();
    	selectedAnswers = [];
	currentQuestion = null;
        // reset khu v·ª±c quiz
        //handleClose();
        setTimeout(() => { topicSection.scrollIntoView({ behavior: 'smooth' }); }, 200);
      });
    });
  </script>
</body>
</html>