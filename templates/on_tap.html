<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√în t·∫≠p Tr·∫Øc nghi·ªám</title>
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --background-light: #e0f2f7;
      --text-dark: #333;
      --card-background: #ffffff;
      --shadow-light: rgba(0, 0, 0, 0.15);
      --border-light: #e0e0e0;
    }
    body {
      font-family: 'Times New Roman', Times, serif;
      background: linear-gradient(135deg, var(--background-light) 0%, #c1dce7 100%);
      margin: 0; padding: 20px; color: var(--text-dark); line-height: 1.6;
    }
    .container {
      max-width: 900px; margin: 30px auto; background: var(--card-background);
      padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.1); position: relative;
    }
    h1,h2,h3 { text-align: center; color: var(--secondary-color); margin-bottom: 25px; font-weight: normal; }
    h1 { font-size: 2.2em; }
    .selection-section { display:flex; flex-wrap:wrap; justify-content:center; gap:15px; margin-top:20px; }
    .card{
      background:#fff; border-radius:8px; box-shadow:0 4px 15px var(--shadow-light);
      padding:15px 25px; text-align:center; cursor:pointer; transition:.3s; width:220px;
      border:2px solid transparent; position:relative;
    }
    .card:hover{ transform: translateY(-4px); box-shadow:0 8px 20px var(--shadow-light); }
    .card.selected{ border-color: var(--primary-color); }
    .card h3{ margin:0; color:var(--text-dark); font-size:1.05em; font-weight:normal; }
    .trial-label{ display:none; color:#f44336; font-size:.9em; position:absolute; bottom:6px; right:10px; }
    .trial-label.show{ display:block; }

    #topic-section{ margin-top:30px; display:none; border-top:1px solid var(--border-light); padding-top:25px; }
    #quiz-section{ margin-top:25px; display:none; border-top:1px solid var(--border-light); padding-top:20px; position:relative; }

    .question-card{ margin-bottom:16px; padding:18px; border-radius:10px; background:#f9f9f9; box-shadow:0 4px 15px rgba(0,0,0,.05);}
    .question-card p.question-text{ color:var(--primary-color); white-space:pre-wrap; }

    .answers{ display:flex; flex-direction:column; gap:10px; }
    .answer-label{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 15px; border:1px solid var(--border-light); border-radius:8px; background:#fff; cursor:pointer;
    }
    .answer-left { display:flex; align-items:center; gap:12px; }
    .answer-label input[type="checkbox"]{ width:18px; height:18px; }
    .chip { font-weight:bold; min-width:24px; text-align:center; }

    .quiz-controls{ display:flex; justify-content:flex-end; margin-top:16px; gap:10px; }
    .quiz-controls button{
      padding:10px 16px; border:none; border-radius:6px; color:#fff; cursor:pointer;
    }
    #submit-btn{ background:var(--primary-color); }
    #next-btn{ background:var(--secondary-color); }
    #close-btn{
      position:absolute; top:15px; right:15px; background:#f44336; color:#fff; border:none;
      border-radius:50%; width:32px; height:32px; font-size:1.2em; line-height:32px; cursor:pointer; display:none;
    }

    .correct{ background-color:#e8f5e9; border-color:#81c784; }
    .incorrect{ background-color:#fdecea; border-color:#f5a5a5; }
    .icon{ margin-left:8px; }
    .icon.ok{ color:#2e7d32; }
    .icon.no{ color:#c62828; }

    #note-section{ margin-top:12px; display:none; background:#fff; border-left:4px solid var(--secondary-color);
      padding:12px 14px; border-radius:6px; }
    #note-section h4{ margin:0 0 6px 0; color:#1976d2; font-weight:normal; }
  </style>
</head>
<body>
  <div class="container">
    <button id="close-btn" title="ƒê√≥ng">&times;</button>
    <h1>√în t·∫≠p Tr·∫Øc nghi·ªám H·∫£i quan üìö</h1>

    <div id="subject-selection">
      <h2>Ch·ªçn m√¥n thi</h2>
      <div class="selection-section">
        <div class="card" data-subject="1">
          <h3>Ph√°p lu·∫≠t h·∫£i quan</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
        <div class="card" data-subject="2">
          <h3>K·ªπ thu·∫≠t nghi·ªáp v·ª• ngo·∫°i th∆∞∆°ng</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
        <div class="card" data-subject="3">
          <h3>K·ªπ thu·∫≠t nghi·ªáp v·ª• h·∫£i quan</h3>
          <span class="trial-label">(d√πng th·ª≠)</span>
        </div>
      </div>
    </div>

    <div id="topic-section">
      <h2>Ch·ªçn lƒ©nh v·ª±c</h2>
      <div class="selection-section" id="topic-selection"></div>
    </div>

    <div id="quiz-section">
      <h2 id="quiz-title"></h2>
      <div id="quiz-questions"></div>
      <div id="note-section">
        <h4>Ghi ch√∫</h4>
        <div id="note-text"></div>
      </div>
      <div class="quiz-controls">
        <button id="submit-btn">Tr·∫£ l·ªùi</button>
        <button id="next-btn">C√¢u ti·∫øp</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Bi·∫øn tr·∫°ng th√°i ======
    let selectedAnswers = [];            // M·∫£ng key A/B/C/D ƒëang ƒë∆∞·ª£c ch·ªçn
    let usedQuestionIds = new Set();     // Id c√¢u h·ªèi ƒë√£ d√πng ƒë·ªÉ lo·∫°i tr·ª´
    let currentQuestion = null;          // L∆∞u c√¢u h·ªèi hi·ªán t·∫°i (ƒë·ªÉ ch·∫•m tr√™n client)
    let currentTopic = { code: null, name: null };

    // C√°c ph·∫ßn t·ª≠ DOM
    const subjectCards = document.querySelectorAll('#subject-selection .card');
    const topicSelectionSection = document.getElementById('topic-selection');
    const topicSection = document.getElementById('topic-section');
    const quizSection = document.getElementById('quiz-section');
    const quizTitle = document.getElementById('quiz-title');
    const quizQuestionsContainer = document.getElementById('quiz-questions');
    const nextBtn = document.getElementById('next-btn');
    const closeBtn = document.getElementById('close-btn');
    const submitBtn = document.getElementById('submit-btn');
    const noteWrap = document.getElementById('note-section');
    const noteText = document.getElementById('note-text');

    // D·ªØ li·ªáu b·∫£n quy·ªÅn render t·ª´ backend (n·∫øu kh√¥ng c√≥, m·∫∑c ƒë·ªãnh all false ƒë·ªÉ kh√¥ng l·ªói)
    const ban_quyen = (typeof {{ ban_quyen|tojson if ban_quyen is defined else "null" }} !== 'undefined' && {{ ban_quyen|tojson if ban_quyen is defined else "null" }}) || { "1": false, "2": false, "3": false };

    // mapping m√£ m√¥n -> { m√£ lƒ©nh v·ª±c: t√™n lƒ©nh v·ª±c }
    const topics = {
      '1': { '11': 'Ph√°p lu·∫≠t h·∫£i quan', '12': 'Ch√≠nh s√°ch thu·∫ø', '13': 'Vi ph·∫°m h√†nh ch√≠nh' },
      '2': { '21': 'Giao nh·∫≠n v·∫≠n t·∫£i', '22': 'Ngo·∫°i th∆∞∆°ng', '23': 'Thanh to√°n qu·ªëc t·∫ø' },
      '3': { '31': 'Th·ªß t·ª•c h·∫£i quan', '32': 'Ch√≠nh s√°ch m·∫∑t h√†ng', '33': 'Tr·ªã gi√° h·∫£i quan', '34': 'Xu·∫•t x·ª© h√†ng h√≥a', '35': 'S·ªü h·ªØu tr√≠ tu·ªá', '36': 'Ph√¢n lo·∫°i h√†ng h√≥a' }
    };

    // Hi·ªÉn th·ªã nh√£n "d√πng th·ª≠"
    subjectCards.forEach(card => {
      const monCode = card.dataset.subject;
      const trialLabel = card.querySelector('.trial-label');
      if (!ban_quyen[monCode]) trialLabel.classList.add('show');
    });

    // Render c√°c th·∫ª lƒ©nh v·ª±c
    function renderTopicCards(monCode) {
      topicSelectionSection.innerHTML = '';
      const topicList = topics[monCode] || {};
      Object.entries(topicList).forEach(([maMonThi, tenLinhVuc]) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.topic = maMonThi; // 11,12,13,21...
        card.innerHTML = `<h3>${tenLinhVuc}</h3>`;
        card.addEventListener('click', () => {
          document.querySelectorAll('#topic-selection .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          usedQuestionIds.clear();
          currentTopic = { code: maMonThi, name: tenLinhVuc };
          startQuiz(maMonThi, tenLinhVuc);
        });
        topicSelectionSection.appendChild(card);
      });
      topicSection.style.display = 'block';
    }

    // B·∫Øt ƒë·∫ßu quiz cho m·ªôt lƒ©nh v·ª±c
    async function startQuiz(maMonThi, tenLinhVuc) {
      await loadNewQuestion(maMonThi, tenLinhVuc);
    }

    // T·∫£i c√¢u h·ªèi m·ªõi t·ª´ backend
    async function loadNewQuestion(maMonThi, tenLinhVuc) {
      try {
        selectedAnswers = [];
        noteWrap.style.display = 'none';
        noteText.textContent = '';

        const res = await fetch("/api/get-question", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ma_mon_thi: maMonThi,
            exclude_ids: Array.from(usedQuestionIds)
          })
        });

        // N·∫øu backend tr·∫£ v·ªÅ l·ªói HTML, parse JSON s·∫Ω l·ªói ‚Äî x·ª≠ l√Ω an to√†n
        let data = null;
        try { data = await res.json(); } catch(e) { data = null; }

        if (!data || !data.questions || data.questions.length === 0) {
          quizQuestionsContainer.innerHTML = "<p>Kh√¥ng c√≤n c√¢u h·ªèi cho lƒ©nh v·ª±c n√†y ho·∫∑c l·ªói m√°y ch·ªß.</p>";
          quizSection.style.display = 'block';
          quizTitle.textContent = tenLinhVuc || '√în t·∫≠p';
          closeBtn.style.display = 'block';
          return;
        }

        const q = data.questions[0];
        currentQuestion = normalizeQuestion(q); // Chu·∫©n h√≥a keys/text
        usedQuestionIds.add(currentQuestion.id);

        quizTitle.textContent = tenLinhVuc || '√în t·∫≠p';
        displayQuestion(currentQuestion);
        quizSection.style.display = 'block';
        closeBtn.style.display = 'block';
      } catch (err) {
        console.error("L·ªói khi t·∫£i c√¢u h·ªèi:", err);
        quizQuestionsContainer.innerHTML = "<p>L·ªói server!</p>";
        quizSection.style.display = 'block';
      }
    }

    // Chu·∫©n h√≥a question: b·∫£o ƒë·∫£m answers c√≥ key l√† A/B/C/D
    function normalizeQuestion(q) {
      // q.answers c√≥ th·ªÉ c√≥ key d·∫°ng "dap_an_a" ... => map sang A/B/C/D
      const mapKey = (k) => {
        if (!k) return '';
        const last = k.slice(-1).toUpperCase();
        return ['A','B','C','D'].includes(last) ? last : k.toUpperCase();
      };
      const answers = (q.answers || [])
        .map(a => ({ key: mapKey(a.key), text: a.text }))
        .filter(a => a.text && String(a.text).trim() !== '' && String(a.text).trim() !== 'NaN' && ['A','B','C','D'].includes(a.key));

      // correct_answer: "A" ho·∫∑c "ABCD" -> set k√Ω t·ª± duy nh·∫•t
      const rawCorrect = (q.correct_answer || '').toString().toUpperCase();
      const correctSet = new Set(rawCorrect.split('').filter(ch => ['A','B','C','D'].includes(ch)));

      // note: ·∫©n n·∫øu tr·ªëng/NaN
      const note = (q.note || '').toString().trim();
      const safeNote = (note && note !== 'NaN') ? note : '';

      return {
        id: q.id,
        question: q.question || q.cau_hoi || '',
        answers,
        correct_answer: Array.from(correctSet).join(''), // ƒë√£ lo·∫°i tr√πng
        note: safeNote
      };
    }

    // Hi·ªÉn th·ªã c√¢u h·ªèi + ƒë√°p √°n
    function displayQuestion(question) {
      quizQuestionsContainer.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'question-card';
      wrap.dataset.maMonThi = currentTopic.code || '';

      const html = `
        <p class="question-text">${question.question || ''}</p>
        <div class="answers"></div>
      `;
      wrap.innerHTML = html;
      quizQuestionsContainer.appendChild(wrap);

      const answersContainer = wrap.querySelector('.answers');
      question.answers.forEach(ans => {
        const label = document.createElement('label');
        label.className = 'answer-label';
        label.dataset.key = ans.key;

        const left = document.createElement('div');
        left.className = 'answer-left';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = ans.key; // GI√Å TR·ªä = A/B/C/D ƒë·ªÉ so s√°nh chu·∫©n
        cb.addEventListener('change', () => toggleAnswer(ans.key, cb));

        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = ans.key;

        const textSpan = document.createElement('span');
        textSpan.textContent = ans.text;

        left.appendChild(cb);
        left.appendChild(chip);
        left.appendChild(textSpan);

        const right = document.createElement('span');
        right.className = 'icon';

        label.appendChild(left);
        label.appendChild(right);
        answersContainer.appendChild(label);
      });
    }

    // Qu·∫£n l√Ω ch·ªçn/b·ªè ch·ªçn ƒë√°p √°n
    function toggleAnswer(key, checkbox) {
      if (checkbox.checked) {
        if (!selectedAnswers.includes(key)) selectedAnswers.push(key);
      } else {
        selectedAnswers = selectedAnswers.filter(k => k !== key);
      }
    }

    // Ch·∫•m ƒëi·ªÉm tr√™n client (kh√¥ng g·ªçi API)
    function handleAnswer() {
      if (!currentQuestion) return;

      const answersContainer = document.querySelector('.answers');
      if (!answersContainer) return;

      // T·∫≠p ƒë√°p √°n ƒë√∫ng
      const correctSet = new Set((currentQuestion.correct_answer || '').split('').filter(ch => ['A','B','C','D'].includes(ch)));

      // Danh s√°ch key ƒë√£ ch·ªçn
      const picked = Array.from(answersContainer.querySelectorAll('input:checked')).map(i => i.value);

      // ƒê√°nh d·∫•u hi·ªÉn th·ªã
      Array.from(answersContainer.children).forEach(label => {
        const key = label.dataset.key;
        const rightIcon = label.querySelector('.icon');

        // reset tr·∫°ng th√°i
        label.classList.remove('correct','incorrect');
        rightIcon.textContent = '';
        rightIcon.classList.remove('ok','no');

        if (correctSet.has(key)) {
          // b√¥i xanh t·∫•t c·∫£ ƒë√°p √°n ƒë√∫ng
          label.classList.add('correct');
          rightIcon.textContent = '‚úîÔ∏è';
          rightIcon.classList.add('ok');
        }
        if (picked.includes(key) && !correctSet.has(key)) {
          // nh·ªØng ƒë√°p √°n ch·ªçn sai -> b√¥i ƒë·ªè
          label.classList.add('incorrect');
          rightIcon.textContent = '‚ùå';
          rightIcon.classList.add('no');
        }
      });

      // Hi·ªán ghi ch√∫ n·∫øu c√≥
      if (currentQuestion.note && currentQuestion.note.trim() !== '' && currentQuestion.note !== 'NaN') {
        noteText.textContent = currentQuestion.note;
        noteWrap.style.display = 'block';
      } else {
        noteWrap.style.display = 'none';
        noteText.textContent = '';
      }
    }

    // C√¢u ti·∫øp
    function handleNext() {
      const cur = document.querySelector('#topic-selection .card.selected');
      if (!cur) return;
      const maMonThi = cur.dataset.topic;
      const tenLinhVuc = cur.textContent.trim();
      loadNewQuestion(maMonThi, tenLinhVuc);
    }

    // ƒê√≥ng kh·ªëi quiz
    function handleClose() {
      quizSection.style.display = 'none';
      quizQuestionsContainer.innerHTML = '';
      noteWrap.style.display = 'none';
      noteText.textContent = '';
      closeBtn.style.display = 'none';
      selectedAnswers = [];
      currentQuestion = null;
      usedQuestionIds.clear();
    }

    // G√°n s·ª± ki·ªán
    submitBtn.addEventListener('click', handleAnswer);
    nextBtn.addEventListener('click', handleNext);
    closeBtn.addEventListener('click', handleClose);

    subjectCards.forEach(card => {
      card.addEventListener('click', () => {
        subjectCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        const monCode = card.dataset.subject;
        renderTopicCards(monCode);
        // reset khu v·ª±c quiz
        handleClose();
        setTimeout(() => { topicSection.scrollIntoView({ behavior: 'smooth' }); }, 200);
      });
    });
  </script>
</body>
</html>
