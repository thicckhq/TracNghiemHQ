<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ôn tập</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    .card { border: 1px solid #ccc; padding: 10px; margin: 5px; cursor: pointer; border-radius: 6px; transition: 0.2s; }
    .card:hover { background: #f5f5f5; }
    .card.selected { border: 2px solid green; background: #f0fff0; }
    .question-card { margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .question-text { font-weight: bold; margin-bottom: 10px; }
    .answer-label { display: block; margin: 6px 0; padding: 8px; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; transition: 0.2s; }
    .answer-label:hover { background: #f9f9f9; }
    .answer-label.correct { background: #e6ffe6; border-color: #33cc33; color: #006600; font-weight: bold; }
    .answer-label.incorrect { background: #ffe6e6; border-color: #ff4d4d; color: #cc0000; font-weight: bold; }
    .icon { margin-left: 8px; font-size: 14px; }
    .quiz-controls { margin-top: 15px; }
    .quiz-controls button { margin-right: 10px; padding: 8px 14px; border-radius: 6px; cursor: pointer; border: none; }
    #submit-btn { background: #007bff; color: #fff; }
    #submit-btn:hover { background: #0066cc; }
    #next-btn { background: #28a745; color: #fff; }
    #next-btn:hover { background: #218838; }
    #note-section { margin-top: 15px; padding: 12px; border-left: 4px solid #007bff; background: #f0f8ff; display: none; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Ôn tập</h1>

  <!-- Môn thi -->
  <div id="subject-selection">
    <div class="card" data-subject="1">Môn 1: Pháp luật hải quan</div>
    <div class="card" data-subject="2">Môn 2: Kỹ thuật nghiệp vụ ngoại thương</div>
    <div class="card" data-subject="3">Môn 3: Nghiệp vụ hải quan</div>
  </div>

  <!-- Lĩnh vực -->
  <div id="topic-selection" style="display:none; margin-top:20px;"></div>

  <!-- Khu vực câu hỏi -->
  <div id="quiz-section" style="display:none; margin-top:20px;">
    <h2 id="quiz-title"></h2>
    <div id="quiz-questions"></div>
    <div class="quiz-controls">
      <button id="submit-btn">Trả lời</button>
      <button id="next-btn">Câu tiếp</button>
    </div>
    <div id="note-section"></div>
  </div>

  <script>
    const topics = {
      "1": { "11": "Pháp luật hải quan", "12": "Chính sách thuế", "13": "Vi phạm hành chính" },
      "2": { "21": "Giao nhận vận tải", "22": "Ngoại thương", "23": "Thanh toán quốc tế" },
      "3": { "31": "Thủ tục hải quan", "32": "Chính sách mặt hàng", "33": "Trị giá hải quan", "34": "Xuất xứ hàng hóa", "35": "Sở hữu trí tuệ", "36": "Phân loại hàng hóa" }
    };

    const subjectCards = document.querySelectorAll('#subject-selection .card');
    const topicSelectionSection = document.getElementById('topic-selection');
    const quizSection = document.getElementById('quiz-section');
    const quizQuestionsContainer = document.getElementById('quiz-questions');
    const quizTitle = document.getElementById('quiz-title');
    const noteSection = document.getElementById('note-section');
    const submitBtn = document.getElementById('submit-btn');
    const nextBtn = document.getElementById('next-btn');

    let usedQuestionIds = new Set();
    let selectedAnswers = [];
    let currentTopic = null;

    function renderTopicCards(monCode) {
      topicSelectionSection.innerHTML = '';
      const topicList = topics[monCode] || {};
      Object.entries(topicList).forEach(([maMonThi, tenLinhVuc]) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.topic = maMonThi;
        card.innerHTML = `<h3>${tenLinhVuc}</h3>`;
        card.addEventListener('click', () => {
          document.querySelectorAll('#topic-selection .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          usedQuestionIds.clear();
          selectedAnswers = [];
          currentTopic = { code: maMonThi, name: tenLinhVuc };
          startQuiz(maMonThi, tenLinhVuc);
        });
        topicSelectionSection.appendChild(card);
      });
      topicSelectionSection.style.display = 'block';
    }

    async function startQuiz(maMonThi, tenLinhVuc) {
      await loadNewQuestion(maMonThi, tenLinhVuc);
    }

    async function loadNewQuestion(maMonThi, tenLinhVuc) {
      try {
        const res = await fetch("/api/get-question", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ma_mon_thi: maMonThi, exclude_ids: Array.from(usedQuestionIds) })
        });
        const data = await res.json();
        if (!data.questions || data.questions.length === 0) {
          quizQuestionsContainer.innerHTML = "<p>Không còn câu hỏi nào cho lĩnh vực này.</p>";
          quizSection.style.display = 'block';
          return;
        }
        let q = data.questions[0];
        usedQuestionIds.add(q.id);
        quizSection.style.display = 'block';
        quizTitle.textContent = tenLinhVuc;
        displayQuestion(q, maMonThi);
        noteSection.style.display = 'none';
      } catch (err) {
        console.error("Lỗi khi tải câu hỏi:", err);
        quizQuestionsContainer.innerHTML = "<p>Lỗi server!</p>";
      }
    }

    function displayQuestion(question, maMonThi) {
      quizQuestionsContainer.innerHTML = '';
      const questionCard = document.createElement('div');
      questionCard.className = 'question-card';
      questionCard.dataset.maMonThi = maMonThi;
      questionCard.innerHTML = `<p class="question-text">${question.question}</p><div class="answers"></div>`;
      quizQuestionsContainer.appendChild(questionCard);
      const answersContainer = questionCard.querySelector('.answers');
      question.answers.forEach((answer) => {
        if (answer && answer !== "NaN") {
          const label = document.createElement('label');
          label.className = 'answer-label';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = answer;
          checkbox.addEventListener('change', () => toggleAnswer(answer, checkbox));
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(answer));
          answersContainer.appendChild(label);
        }
      });
    }

    function toggleAnswer(answer, checkbox) {
      if (checkbox.checked) {
        selectedAnswers.push(answer);
      } else {
        selectedAnswers = selectedAnswers.filter(item => item !== answer);
      }
    }

    async function handleAnswer() {
      const currentQuestion = document.querySelector('.question-card');
      if (!currentQuestion) return;

      const res = await fetch("/api/get-question", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ma_mon_thi: currentQuestion.dataset.maMonThi,
          selected_answers: selectedAnswers
        })
      });
      const data = await res.json();

      if (data.questions && data.questions.length > 0) {
        const question = data.questions[0];
        displayAnswersWithResults(question);
      } else {
        alert("Không có câu hỏi để hiển thị");
      }
    }

    function displayAnswersWithResults(question) {
      const answersContainer = document.querySelector('.answers');
      const correctAnswers = question.correct_answer.split('');

      Array.from(answersContainer.children).forEach(label => {
        const answerValue = label.querySelector('input').value;
        if (correctAnswers.includes(answerValue)) {
          label.classList.add('correct');
          label.innerHTML += ' <span class="icon">✅</span>';
        } else if (selectedAnswers.includes(answerValue)) {
          label.classList.add('incorrect');
          label.innerHTML += ' <span class="icon">❌</span>';
        }
      });

      if (question.note) {
        noteSection.innerHTML = `<p><b>Ghi chú:</b> ${question.note}</p>`;
        noteSection.style.display = 'block';
      } else {
        noteSection.style.display = 'none';
      }
    }

    if (submitBtn) submitBtn.addEventListener('click', handleAnswer);
    if (nextBtn) nextBtn.addEventListener('click', () => {
      if (currentTopic) {
        loadNewQuestion(currentTopic.code, currentTopic.name);
        selectedAnswers = [];
      }
    });

    subjectCards.forEach(card => {
      card.addEventListener('click', () => {
        subjectCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        renderTopicCards(card.dataset.subject);
        quizSection.style.display = 'none';
        quizQuestionsContainer.innerHTML = '';
        usedQuestionIds.clear();
        selectedAnswers = [];
      });
    });
  </script>
</body>
</html>
